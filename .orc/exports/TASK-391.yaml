version: 2
exported_at: 2026-01-16T23:27:36.895171292-06:00
task:
    id: TASK-391
    title: Implement GET /api/agents/stats for per-agent metrics
    description: |-
        Add GET /api/agents/stats endpoint returning per-agent statistics for the Agents view cards.

        **Response Schema:**
        ```json
        {
          "agents": [
            {
              "name": "Primary Coder",
              "model": "claude-sonnet-4-20250514",
              "status": "active",
              "stats": {
                "tokens_today": 847000,
                "tasks_done_today": 34,
                "tasks_done_total": 247,
                "success_rate": 0.94,
                "avg_task_time_seconds": 180
              },
              "tools": ["File Read/Write", "Bash", "Web Search", "MCP"],
              "last_activity": "2026-01-16T14:30:00Z"
            },
            {
              "name": "Quick Tasks",
              "model": "claude-haiku-3-5-20241022",
              "status": "idle",
              "stats": {
                "tokens_today": 124000,
                "tasks_done_today": 12,
                "tasks_done_total": 89,
                "success_rate": 0.91,
                "avg_task_time_seconds": 45
              },
              "tools": ["File Read", "Web Search"],
              "last_activity": "2026-01-16T12:15:00Z"
            }
          ],
          "summary": {
            "total_agents": 3,
            "active_agents": 1,
            "total_tokens_today": 1227000,
            "total_tasks_today": 54
          }
        }
        ```

        **Implementation:**
        1. Create handler in internal/api/handlers_agents.go
        2. Load agent definitions from GET /api/agents
        3. For each agent, aggregate stats from tasks where session_model matches
        4. Calculate tokens_today by summing today's task token usage
        5. Calculate success_rate from completed vs failed tasks per agent
        6. Determine status based on whether agent has running tasks
        7. Register route: GET /api/agents/stats

        **Notes:**
        - If no agent configs exist, return agents grouped by model from task history
        - 'today' means since midnight local time
        - status: 'active' if agent has a running task, otherwise 'idle'

        **Files to create/modify:**
        - internal/api/handlers_agents.go (create if needed, or add to existing)
        - internal/api/server.go (register route)

        **Success criteria:**
        - Returns stats per configured agent
        - Tokens and tasks aggregated correctly per agent/model
        - Success rate calculated correctly
        - Status reflects current running state
        - Empty response handled gracefully (no agents configured)

        **Reference:** example_ui/agents.html agent-cards section (lines 502-591)
    weight: small
    status: planned
    branch: orc/TASK-391
    queue: active
    priority: normal
    category: feature
    initiative_id: INIT-023
    created_at: 2026-01-16T22:48:34-06:00
    updated_at: 0001-01-01T00:00:00Z
plan:
    version: 1
    task_id: TASK-391
    weight: small
    description: Small task - implement with tests, fully automated
    phases:
        - id: implement
          name: implement
          prompt: |
            Implement the following task:

            **Task**: {{TASK_TITLE}}

            **Description**: {{TASK_DESCRIPTION}}

            {{RETRY_CONTEXT}}

            1. Implement the required changes
            2. Write/update tests as needed
            3. Run tests and fix any failures

            Keep iterating until implementation is complete and all tests pass.

            When done, output:
            <phase_complete>true</phase_complete>
          gate:
            type: auto
          checkpoint: true
          status: pending
        - id: test
          name: test
          prompt: |
            Final test verification for: {{TASK_TITLE}}

            **Original task**: {{TASK_DESCRIPTION}}

            1. Run the full test suite
            2. Fix any failures found
            3. Verify edge cases are covered

            Keep iterating until all tests pass.

            When done, output:
            <phase_complete>true</phase_complete>
          depends_on:
            - implement
          gate:
            type: auto
          checkpoint: true
          status: pending
state:
    task_id: TASK-391
    current_phase: ""
    current_iteration: 0
    status: pending
    started_at: 0001-01-01T00:00:00Z
    updated_at: 0001-01-01T00:00:00Z
    phases: {}
    tokens:
        input_tokens: 0
        output_tokens: 0
        total_tokens: 0
    cost:
        total_cost_usd: 0
