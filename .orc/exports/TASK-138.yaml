version: 2
exported_at: 2026-01-17T08:29:48.026414-06:00
task:
    id: TASK-138
    title: Fix pre-commit hook false positive on main branch
    description: |-
        ## Problem
        The pre-commit hook incorrectly detects the main branch as a task worktree, blocking commits with:

        ```
        ===============================================
          WARNING: Unexpected branch for task
        ===============================================

          Task: TASK-096
          Expected branch: orc/TASK-096
          Current branch: main
        ```

        This happens when committing directly to main, even though we're not in a worktree.

        ## Root Cause
        The hook extracts a task ID from somewhere (possibly file changes or commit message) and assumes we should be on that task's branch. It doesn't distinguish between:
        1. Working in a task worktree (should enforce branch match)
        2. Working on main (no task branch enforcement needed)

        ## Solution
        Update the pre-commit hook to:
        1. Only enforce branch matching when actually in a worktree
        2. Detect if we're in the main repo vs a worktree using git common-dir
        3. Allow commits on main branch without task branch validation

        ## Success Criteria
        1. Commits to main branch succeed without false warnings
        2. Commits in task worktrees still enforce correct branch
        3. Hook correctly detects worktree vs main repo context

        ## Files to Modify
        - .claude/hooks/pre-commit or wherever the hook is defined
    weight: small
    status: completed
    current_phase: test
    branch: orc/TASK-138
    queue: active
    priority: normal
    category: bug
    created_at: 2026-01-14T01:43:16-06:00
    updated_at: 0001-01-01T00:00:00Z
    started_at: 2026-01-14T01:46:38-06:00
    completed_at: 2026-01-14T01:54:12-06:00
plan:
    version: 1
    task_id: TASK-138
    weight: small
    description: Small task - implement with tests, fully automated
    phases:
        - id: implement
          name: implement
          prompt: |
            Implement the following task:

            **Task**: {{TASK_TITLE}}

            **Description**: {{TASK_DESCRIPTION}}

            {{RETRY_CONTEXT}}

            1. Implement the required changes
            2. Write/update tests as needed
            3. Run tests and fix any failures

            Keep iterating until implementation is complete and all tests pass.

            When done, output:
            <phase_complete>true</phase_complete>
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: b9ee1ddd5cee4f619f3b7f0e5c2ec0260ae0d031
        - id: test
          name: test
          prompt: |
            Final test verification for: {{TASK_TITLE}}

            **Original task**: {{TASK_DESCRIPTION}}

            1. Run the full test suite
            2. Fix any failures found
            3. Verify edge cases are covered

            Keep iterating until all tests pass.

            When done, output:
            <phase_complete>true</phase_complete>
          depends_on:
            - implement
          gate:
            type: auto
          checkpoint: true
          status: completed
state:
    task_id: TASK-138
    current_phase: test
    current_iteration: 0
    status: completed
    started_at: 2026-01-14T01:46:38-06:00
    updated_at: 0001-01-01T00:00:00Z
    phases:
        implement:
            status: completed
            started_at: 2026-01-14T01:46:39-06:00
            completed_at: 2026-01-14T01:51:41-06:00
            iterations: 1
            commit_sha: b9ee1ddd5cee4f619f3b7f0e5c2ec0260ae0d031
            tokens:
                input_tokens: 2506167
                output_tokens: 12102
                total_tokens: 0
        test:
            status: completed
            started_at: 2026-01-14T01:51:41-06:00
            completed_at: 2026-01-14T01:54:12-06:00
            iterations: 1
            tokens:
                input_tokens: 1129964
                output_tokens: 2583
                total_tokens: 0
    gates:
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T01:51:41-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T01:51:41-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T01:54:12-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T01:54:12-06:00
    tokens:
        input_tokens: 0
        output_tokens: 0
        total_tokens: 0
    cost:
        total_cost_usd: 0
gate_decisions:
    - id: 5
      taskid: TASK-138
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T01:51:41-06:00
    - id: 7
      taskid: TASK-138
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T01:51:41-06:00
    - id: 6
      taskid: TASK-138
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T01:54:12-06:00
    - id: 8
      taskid: TASK-138
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T01:54:12-06:00
