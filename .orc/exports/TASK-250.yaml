version: 2
exported_at: 2026-01-17T08:29:46.04063-06:00
task:
    id: TASK-250
    title: 'Fix: Heartbeat goes stale during long phases causing false orphan detection'
    weight: medium
    status: completed
    current_phase: docs
    branch: orc/TASK-250
    queue: active
    priority: high
    category: bug
    initiative_id: INIT-012
    created_at: 2026-01-15T17:14:56-06:00
    updated_at: 0001-01-01T00:00:00Z
    started_at: 2026-01-15T17:48:48-06:00
    completed_at: 2026-01-15T18:17:40-06:00
plan:
    version: 1
    task_id: TASK-250
    weight: medium
    description: Medium task - spec, implement, test, docs with clear success criteria
    phases:
        - id: spec
          name: spec
          prompt: |
            Create a specification for this task:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}
            **Description**: {{TASK_DESCRIPTION}}

            {{INITIATIVE_CONTEXT}}

            ## Instructions

            Create a clear, actionable specification that defines exactly what needs to be done
            and how to verify it's complete.

            ### 1. Problem Statement
            Summarize what needs to be solved in 1-2 sentences.

            ### 2. Success Criteria (REQUIRED)
            Define specific, testable criteria as checkboxes:
            - Each criterion must be verifiable (file exists, test passes, API returns X)
            - No vague language ("works well", "is fast")
            - Include both functional and quality criteria

            ### 3. Testing Requirements (REQUIRED)
            Specify what tests must pass:
            - [ ] Unit test: [specific test description]
            - [ ] Integration test: [if applicable]
            - [ ] E2E test: [if UI changes]

            ### 4. Scope
            Define boundaries to prevent scope creep:
            - **In Scope**: What will be implemented
            - **Out of Scope**: What will NOT be implemented

            ### 5. Technical Approach
            Brief plan for implementation:
            - Files to modify
            - Key changes in each file

            ### 6. Category-Specific Analysis

            **If this is a BUG (category=bug):**
            - Reproduction Steps: Exact steps to trigger the bug
            - Current Behavior: What happens now (the bug)
            - Expected Behavior: What should happen
            - Root Cause: Where the bug originates (if known)
            - Verification: How to confirm the fix works

            **If this is a FEATURE (category=feature):**
            - User Story: As a [user], I want [feature] so that [benefit]
            - Acceptance Criteria: Specific conditions for feature acceptance

            **If this is a REFACTOR (category=refactor):**
            - Before Pattern: Current code/architecture
            - After Pattern: Target code/architecture
            - Risk Assessment: What could break

            ## Output Format

            Wrap your spec in artifact tags:

            <artifact>
            # Specification: {{TASK_TITLE}}

            ## Problem Statement
            [1-2 sentences]

            ## Success Criteria
            - [ ] [Criterion 1]
            - [ ] [Criterion 2]

            ## Testing Requirements
            - [ ] [Test 1]
            - [ ] [Test 2]

            ## Scope
            ### In Scope
            - [Item]
            ### Out of Scope
            - [Item]

            ## Technical Approach
            [Brief implementation plan]

            ### Files to Modify
            - [file]: [change]

            ## [Category-Specific Section]
            [Include appropriate section based on category]
            </artifact>

            After completing the spec, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: spec - completed"
            ```

            Then output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```

            If blocked (requirements unclear):
            ```
            <phase_blocked>
            reason: [what's unclear]
            needs: [what clarification is needed]
            </phase_blocked>
            ```
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: ce18626be51674da27baf4a570fd5c440e6b13d6
        - id: implement
          name: implement
          prompt: |
            Implement the task according to the specification:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            {{INITIATIVE_CONTEXT}}

            ## Specification

            {{SPEC_CONTENT}}

            {{RETRY_CONTEXT}}

            ## Instructions

            1. Review the spec's success criteria - these are your acceptance criteria
            2. Implement the required changes following the technical approach
            3. Write/update tests alongside code (as specified in Testing Requirements)
            4. Run tests and fix any failures
            5. Self-review against success criteria before completing

            ### Self-Review Checklist
            - [ ] All success criteria from spec addressed
            - [ ] All testing requirements satisfied
            - [ ] Scope boundaries respected (no extra features)
            - [ ] Error handling complete
            - [ ] Code follows project patterns

            Keep iterating until implementation is complete and tests pass.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: implement - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - spec
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: fb20783d0146778e95346dbc3a51c7bb3e446c8a
        - id: test
          name: test
          prompt: |
            Test and review the implementation:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            ## Specification

            {{SPEC_CONTENT}}

            ## Instructions

            1. Run the full test suite
            2. Verify all Testing Requirements from spec are satisfied
            3. Review code for quality issues
            4. Check for edge cases and security issues
            5. Fix any problems found

            ### Verification Against Spec
            Go through each Success Criterion and Testing Requirement from the spec
            and verify it's satisfied.

            Keep iterating until all tests pass and code quality is acceptable.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: test - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - implement
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: 640a793aeca679bdaa41643386d3575cd2d01a55
        - id: docs
          name: docs
          prompt: |
            Update documentation for:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            ## Specification

            {{SPEC_CONTENT}}

            ## Instructions

            1. Update any relevant documentation files
            2. Ensure CLAUDE.md reflects the changes if applicable
            3. Add/update code comments where needed
            4. Update README if user-facing changes were made

            Keep iterating until documentation is complete.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: docs - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - test
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: f3b18df738860edb78ea524894eb84c8b77b0f4f
spec: |-
    # Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection

    ## Problem Statement
    During long-running phase executions (such as complex implement or finalize phases), the executor's heartbeat timestamp is only updated at the start of each phase, not during the actual LLM session execution. If a single phase takes longer than the 5-minute orphan detection threshold, the task is incorrectly flagged as orphaned despite the executor process still being alive and actively working.

    ## Success Criteria
    - [ ] Heartbeat is updated periodically during phase execution, not just at phase start
    - [ ] Tasks running phases longer than 5 minutes are NOT flagged as orphaned
    - [ ] The heartbeat update mechanism does not significantly impact performance
    - [ ] Heartbeat updates are persisted to the database (not just in-memory)
    - [ ] Existing orphan detection for truly orphaned tasks still works correctly
    - [ ] Test coverage for heartbeat updates during long-running operations

    ## Testing Requirements
    - [ ] Unit test: `TestHeartbeatUpdatedDuringPhaseExecution` - verify heartbeat callback is invoked
    - [ ] Unit test: `TestOrphanDetection_ActiveExecutionWithFreshHeartbeat` - verify active tasks with recent heartbeat are not orphaned
    - [ ] Integration test: Mock a phase execution lasting >5 minutes and verify no false orphan detection

    ## Scope
    ### In Scope
    - Add heartbeat update mechanism during phase execution
    - Wire heartbeat callback to state persistence via `backend.SaveState()`
    - Update `StandardExecutor`, `FullExecutor`, and `FinalizeExecutor` to use the heartbeat callback
    - Add tests for the new heartbeat behavior

    ### Out of Scope
    - Changing the 5-minute orphan detection threshold (already configurable if needed)
    - Modifying the orphan detection logic itself (it correctly handles stale heartbeats)
    - TrivialExecutor changes (trivial tasks are short by design)

    ## Technical Approach

    The heartbeat mechanism exists in `ActivityTracker` via `onHeartbeat` callback, and is already being invoked during `StreamTurnWithProgress`. However, this callback currently only publishes events - it does NOT update the state's heartbeat timestamp or persist it.

    The fix requires:
    1. Pass a heartbeat callback from phase execution that updates and persists `state.UpdateHeartbeat()`
    2. Ensure `backend.SaveState()` is called to persist the heartbeat to the database
    3. This should happen within the existing `StreamProgressOptions.OnHeartbeat` callback chain

    ### Files to Modify
    - `internal/executor/standard.go:Execute()`: Add heartbeat callback that updates and persists state
    - `internal/executor/full.go:Execute()`: Same as standard
    - `internal/executor/finalize.go:Execute()`: Same, using the state updater callback
    - `internal/executor/standard.go`: Accept backend as option for heartbeat persistence
    - `internal/executor/full.go`: Accept backend as option for heartbeat persistence

    ## Bug Analysis

    **Reproduction Steps:**
    1. Create a large/greenfield task that requires complex implementation
    2. Run `orc run TASK-XXX`
    3. Observe phase execution taking >5 minutes (single LLM session can take 10-20 minutes for complex tasks)
    4. In another terminal, run `orc status` or check the web UI
    5. The task shows as "orphaned" despite actively running

    **Current Behavior:**
    - Heartbeat is set at phase start (`s.StartPhase()` -> `s.UpdateHeartbeat()`)
    - During the phase, `StreamTurnWithProgress` emits heartbeat events via `opts.OnHeartbeat()`
    - BUT: This callback only calls `e.publisher.Heartbeat()` - it does NOT update the state's `Execution.LastHeartbeat` timestamp
    - After 5 minutes of phase execution, `CheckOrphaned()` returns true with "heartbeat stale (>5 minutes)"

    **Expected Behavior:**
    - Heartbeat should be updated periodically during phase execution
    - The state's `Execution.LastHeartbeat` field should reflect recent activity
    - Tasks actively executing (with fresh heartbeats) should NOT be flagged as orphaned

    **Root Cause:**
    The `OnHeartbeat` callback in `StreamProgressOptions` (used in `standard.go:227`) only publishes events for UI updates - it doesn't persist the heartbeat to the state/database. The disconnect is between:
    1. `ActivityTracker.onHeartbeat` -> publishes `EventHeartbeat` for WebSocket clients
    2. `State.UpdateHeartbeat()` -> updates `Execution.LastHeartbeat` timestamp
    3. `backend.SaveState()` -> persists state to database

    These three are never connected during phase execution.

    **Verification:**
    - Run a task with a long phase (>5 minutes)
    - Monitor `state.yaml` or database to see `Execution.LastHeartbeat` being updated every 30 seconds
    - Verify `orc status` shows task as running, not orphaned
state:
    task_id: TASK-250
    current_phase: docs
    current_iteration: 0
    status: completed
    started_at: 2026-01-15T17:48:48-06:00
    updated_at: 0001-01-01T00:00:00Z
    phases:
        docs:
            status: completed
            started_at: 2026-01-15T18:15:35-06:00
            completed_at: 2026-01-15T18:17:40-06:00
            iterations: 1
            commit_sha: f3b18df738860edb78ea524894eb84c8b77b0f4f
            tokens:
                input_tokens: 2161731
                output_tokens: 4476
                total_tokens: 0
        implement:
            status: completed
            started_at: 2026-01-15T17:51:30-06:00
            completed_at: 2026-01-15T18:09:55-06:00
            iterations: 3
            commit_sha: fb20783d0146778e95346dbc3a51c7bb3e446c8a
            tokens:
                input_tokens: 25649251
                output_tokens: 71438
                total_tokens: 0
        spec:
            status: completed
            started_at: 2026-01-15T17:48:49-06:00
            completed_at: 2026-01-15T17:51:30-06:00
            iterations: 1
            commit_sha: ce18626be51674da27baf4a570fd5c440e6b13d6
            tokens:
                input_tokens: 2478550
                output_tokens: 6157
                total_tokens: 0
        test:
            status: completed
            started_at: 2026-01-15T18:09:55-06:00
            completed_at: 2026-01-15T18:15:35-06:00
            iterations: 1
            commit_sha: 640a793aeca679bdaa41643386d3575cd2d01a55
            tokens:
                input_tokens: 2939160
                output_tokens: 6074
                total_tokens: 0
    gates:
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T17:51:30-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:09:55-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:15:35-06:00
        - phase: docs
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:17:40-06:00
        - phase: docs
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-15T18:17:40-06:00
    tokens:
        input_tokens: 0
        output_tokens: 0
        total_tokens: 0
    cost:
        total_cost_usd: 0
transcripts:
    - id: 196
      taskid: TASK-250
      phase: docs
      iteration: 1
      role: combined
      content: |
        # docs - Iteration 1

        ## Prompt

        Update documentation for:

        **Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection
        **Category**: {{TASK_CATEGORY}}

        ## Specification

        # Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection

        ## Problem Statement
        [1-2 sentences]

        ## Success Criteria
        - [ ] [Criterion 1]
        - [ ] [Criterion 2]

        ## Testing Requirements
        - [ ] [Test 1]
        - [ ] [Test 2]

        ## Scope
        ### In Scope
        - [Item]
        ### Out of Scope
        - [Item]

        ## Technical Approach
        [Brief implementation plan]

        ### Files to Modify
        - [file]: [change]

        ## [Category-Specific Section]
        [Include appropriate section based on category]

        ## Instructions

        1. Update any relevant documentation files
        2. Ensure CLAUDE.md reflects the changes if applicable
        3. Add/update code comments where needed
        4. Update README if user-facing changes were made

        Keep iterating until documentation is complete.

        After completing, commit:
        ```bash
        git add -A
        git commit -m "[orc] TASK-250: docs - completed"
        ```

        When done, output:
        ```
        **Commit**: [SHA]
        <phase_complete>true</phase_complete>
        ```


        ## Response

        **Commit**: b0f330e5

        Documentation has been updated with:

        1. **CLAUDE.md Knowledge Entry**: Added pattern for "Heartbeat propagation to phase executors" describing how phase executors accept a `heartbeatUpdater` callback that updates state heartbeat during long operations, preventing false orphan detection.

        2. **EXECUTOR.md**: Added new "Heartbeat for Orphan Detection" section covering:
           - The problem: long-running operations exceeding the 5-minute stale threshold
           - When heartbeat updates occur for each executor type
           - Specific operations in FinalizeExecutor that trigger updates
           - Configuration options
           - Executor options for injecting the heartbeat callback

        <phase_complete>true</phase_complete>

        ---
        Tokens: 2161731 input, 4476 output, 117052 cache_creation, 2043134 cache_read
        Complete: true
        Blocked: false
      timestamp: 1768628597
    - id: 197
      taskid: TASK-250
      phase: implement
      iteration: 1
      role: combined
      content: "# implement - Iteration 1\n\n## Prompt\n\nImplement the task according to the specification:\n\n**Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection\n**Category**: {{TASK_CATEGORY}}\n\n{{INITIATIVE_CONTEXT}}\n\n## Specification\n\n# Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection\n\n## Problem Statement\n[1-2 sentences]\n\n## Success Criteria\n- [ ] [Criterion 1]\n- [ ] [Criterion 2]\n\n## Testing Requirements\n- [ ] [Test 1]\n- [ ] [Test 2]\n\n## Scope\n### In Scope\n- [Item]\n### Out of Scope\n- [Item]\n\n## Technical Approach\n[Brief implementation plan]\n\n### Files to Modify\n- [file]: [change]\n\n## [Category-Specific Section]\n[Include appropriate section based on category]\n\n\n\n## Instructions\n\n1. Review the spec's success criteria - these are your acceptance criteria\n2. Implement the required changes following the technical approach\n3. Write/update tests alongside code (as specified in Testing Requirements)\n4. Run tests and fix any failures\n5. Self-review against success criteria before completing\n\n### Self-Review Checklist\n- [ ] All success criteria from spec addressed\n- [ ] All testing requirements satisfied\n- [ ] Scope boundaries respected (no extra features)\n- [ ] Error handling complete\n- [ ] Code follows project patterns\n\nKeep iterating until implementation is complete and tests pass.\n\nAfter completing, commit:\n```bash\ngit add -A\ngit commit -m \"[orc] TASK-250: implement - completed\"\n```\n\nWhen done, output:\n```\n**Commit**: [SHA]\n<phase_complete>true</phase_complete>\n```\n\n\n## Response\n\nImplementation complete. Here's a summary:\n\n**TASK-250: Fix Heartbeat goes stale during long phases causing false orphan detection**\n\n**Problem**: Tasks were incorrectly flagged as orphaned during long-running phases (>5 minutes) because the heartbeat timestamp was only updated at phase start.\n\n**Solution**: Added a `heartbeatUpdater` callback mechanism that updates the heartbeat timestamp every 30 seconds during phase execution:\n\n1. **`internal/executor/standard.go`**: Added `heartbeatUpdater` field and `WithHeartbeatUpdater` option; modified `OnHeartbeat` callback to call updater\n2. **`internal/executor/full.go`**: Same pattern with `WithFullHeartbeatUpdater` \n3. **`internal/executor/executor.go`**: Added `heartbeatUpdater` field and pass it to phase executors in `getPhaseExecutor()`\n4. **`internal/executor/task_execution.go`**: Set up heartbeatUpdater in `ExecuteTask()` that calls `s.UpdateHeartbeat()` and persists state to backend\n\n**Tests**: All executor tests (16.0s) and state tests (0.003s) pass with no regressions.\n\n**Commit**: `ee6827ae [orc] TASK-250: implement - completed`\n\n---\nTokens: 3503253 input, 10024 output, 190414 cache_creation, 3312793 cache_read\nComplete: false\nBlocked: false\n"
      timestamp: 1768628597
    - id: 198
      taskid: TASK-250
      phase: implement
      iteration: 2
      role: combined
      content: |
        # implement - Iteration 2

        ## Prompt

        Implement the task according to the specification:

        **Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection
        **Category**: {{TASK_CATEGORY}}

        {{INITIATIVE_CONTEXT}}

        ## Specification

        # Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection

        ## Problem Statement
        [1-2 sentences]

        ## Success Criteria
        - [ ] [Criterion 1]
        - [ ] [Criterion 2]

        ## Testing Requirements
        - [ ] [Test 1]
        - [ ] [Test 2]

        ## Scope
        ### In Scope
        - [Item]
        ### Out of Scope
        - [Item]

        ## Technical Approach
        [Brief implementation plan]

        ### Files to Modify
        - [file]: [change]

        ## [Category-Specific Section]
        [Include appropriate section based on category]



        ## Instructions

        1. Review the spec's success criteria - these are your acceptance criteria
        2. Implement the required changes following the technical approach
        3. Write/update tests alongside code (as specified in Testing Requirements)
        4. Run tests and fix any failures
        5. Self-review against success criteria before completing

        ### Self-Review Checklist
        - [ ] All success criteria from spec addressed
        - [ ] All testing requirements satisfied
        - [ ] Scope boundaries respected (no extra features)
        - [ ] Error handling complete
        - [ ] Code follows project patterns

        Keep iterating until implementation is complete and tests pass.

        After completing, commit:
        ```bash
        git add -A
        git commit -m "[orc] TASK-250: implement - completed"
        ```

        When done, output:
        ```
        **Commit**: [SHA]
        <phase_complete>true</phase_complete>
        ```


        ## Response

        The implementation is complete. Here's a summary of what was done:

        ## Summary

        **Task**: Fix heartbeat going stale during long phases causing false orphan detection (TASK-250)

        **Problem**: The `FinalizeExecutor` was missing heartbeat support. While `StandardExecutor` and `FullExecutor` had heartbeat updates via the `OnHeartbeat` callback in `StreamTurnWithProgress`, the `FinalizeExecutor` uses direct API calls (`adapter.ExecuteTurn()`) and doesn't benefit from automatic heartbeat updates.

        **Solution**: Added manual heartbeat updates to `FinalizeExecutor` at strategic points during execution:

        ### Changes Made

        1. **`internal/executor/finalize.go`**:
           - Added `heartbeatUpdater func()` field to `FinalizeExecutor` struct (line 51)
           - Added `WithFinalizeHeartbeatUpdater` option function (lines 97-101)
           - Added `updateHeartbeat()` helper method (lines 902-908)
           - Added 7 heartbeat update calls at strategic points in `Execute()`:
             - After fetch (line 190)
             - After divergence check (line 200)
             - Before sync (line 221)
             - Before test execution (line 239)
             - Before AI-assisted test fix (line 252)
             - Before risk assessment (line 273)
             - Before finalize commit (line 289)

        2. **`internal/executor/task_execution.go`**:
           - Added `WithFinalizeHeartbeatUpdater` option when creating `FinalizeExecutor` in `FinalizeTask()` (lines 653-658)

        3. **`internal/executor/finalize_test.go`**:
           - Added `TestWithFinalizeHeartbeatUpdater` test
           - Added `TestFinalizeExecutor_updateHeartbeat` test with nil-safety check
           - Added `TestFinalizeExecutor_updateHeartbeat_MultipleCalls` test

        All tests pass and the build succeeds.

        ---
        Tokens: 9345337 input, 26120 output, 559719 cache_creation, 8785513 cache_read
        Complete: false
        Blocked: false
      timestamp: 1768628597
    - id: 199
      taskid: TASK-250
      phase: implement
      iteration: 3
      role: combined
      content: "# implement - Iteration 3\n\n## Prompt\n\nImplement the task according to the specification:\n\n**Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection\n**Category**: {{TASK_CATEGORY}}\n\n{{INITIATIVE_CONTEXT}}\n\n## Specification\n\n# Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection\n\n## Problem Statement\n[1-2 sentences]\n\n## Success Criteria\n- [ ] [Criterion 1]\n- [ ] [Criterion 2]\n\n## Testing Requirements\n- [ ] [Test 1]\n- [ ] [Test 2]\n\n## Scope\n### In Scope\n- [Item]\n### Out of Scope\n- [Item]\n\n## Technical Approach\n[Brief implementation plan]\n\n### Files to Modify\n- [file]: [change]\n\n## [Category-Specific Section]\n[Include appropriate section based on category]\n\n\n\n## Instructions\n\n1. Review the spec's success criteria - these are your acceptance criteria\n2. Implement the required changes following the technical approach\n3. Write/update tests alongside code (as specified in Testing Requirements)\n4. Run tests and fix any failures\n5. Self-review against success criteria before completing\n\n### Self-Review Checklist\n- [ ] All success criteria from spec addressed\n- [ ] All testing requirements satisfied\n- [ ] Scope boundaries respected (no extra features)\n- [ ] Error handling complete\n- [ ] Code follows project patterns\n\nKeep iterating until implementation is complete and tests pass.\n\nAfter completing, commit:\n```bash\ngit add -A\ngit commit -m \"[orc] TASK-250: implement - completed\"\n```\n\nWhen done, output:\n```\n**Commit**: [SHA]\n<phase_complete>true</phase_complete>\n```\n\n\n## Response\n\nImplementation complete.\n\n**Commit SHA:** `360567880c8b695608089acf6408be3b2d700702`\n\n**Summary of changes:**\n- Modified `resolveConflicts()` in `internal/executor/finalize.go:599-607` to use `StreamTurnWithProgress` with heartbeat support\n- Modified `tryFixTests()` in `internal/executor/finalize.go:767-775` to use `StreamTurnWithProgress` with heartbeat support  \n- Added test `TestFinalizeExecutor_HeartbeatConfigPropagation` in `internal/executor/finalize_test.go:1209-1241`\n\nThis fix ensures the heartbeat timestamp is updated during long-running AI-assisted operations (conflict resolution, test fixing) in the finalize phase, preventing false orphan detection when tasks exceed the 5-minute staleness threshold.\n\n<phase_complete>true</phase_complete>\n\n---\nTokens: 12800661 input, 35294 output, 732335 cache_creation, 12067656 cache_read\nComplete: true\nBlocked: false\n"
      timestamp: 1768628597
    - id: 200
      taskid: TASK-250
      phase: spec
      iteration: 1
      role: combined
      content: "# spec - Iteration 1\n\n## Prompt\n\nCreate a specification for this task:\n\n**Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection\n**Category**: {{TASK_CATEGORY}}\n**Description**: \n\n{{INITIATIVE_CONTEXT}}\n\n## Instructions\n\nCreate a clear, actionable specification that defines exactly what needs to be done\nand how to verify it's complete.\n\n### 1. Problem Statement\nSummarize what needs to be solved in 1-2 sentences.\n\n### 2. Success Criteria (REQUIRED)\nDefine specific, testable criteria as checkboxes:\n- Each criterion must be verifiable (file exists, test passes, API returns X)\n- No vague language (\"works well\", \"is fast\")\n- Include both functional and quality criteria\n\n### 3. Testing Requirements (REQUIRED)\nSpecify what tests must pass:\n- [ ] Unit test: [specific test description]\n- [ ] Integration test: [if applicable]\n- [ ] E2E test: [if UI changes]\n\n### 4. Scope\nDefine boundaries to prevent scope creep:\n- **In Scope**: What will be implemented\n- **Out of Scope**: What will NOT be implemented\n\n### 5. Technical Approach\nBrief plan for implementation:\n- Files to modify\n- Key changes in each file\n\n### 6. Category-Specific Analysis\n\n**If this is a BUG (category=bug):**\n- Reproduction Steps: Exact steps to trigger the bug\n- Current Behavior: What happens now (the bug)\n- Expected Behavior: What should happen\n- Root Cause: Where the bug originates (if known)\n- Verification: How to confirm the fix works\n\n**If this is a FEATURE (category=feature):**\n- User Story: As a [user], I want [feature] so that [benefit]\n- Acceptance Criteria: Specific conditions for feature acceptance\n\n**If this is a REFACTOR (category=refactor):**\n- Before Pattern: Current code/architecture\n- After Pattern: Target code/architecture\n- Risk Assessment: What could break\n\n## Output Format\n\nWrap your spec in artifact tags:\n\n<artifact>\n# Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection\n\n## Problem Statement\n[1-2 sentences]\n\n## Success Criteria\n- [ ] [Criterion 1]\n- [ ] [Criterion 2]\n\n## Testing Requirements\n- [ ] [Test 1]\n- [ ] [Test 2]\n\n## Scope\n### In Scope\n- [Item]\n### Out of Scope\n- [Item]\n\n## Technical Approach\n[Brief implementation plan]\n\n### Files to Modify\n- [file]: [change]\n\n## [Category-Specific Section]\n[Include appropriate section based on category]\n</artifact>\n\nAfter completing the spec, commit:\n```bash\ngit add -A\ngit commit -m \"[orc] TASK-250: spec - completed\"\n```\n\nThen output:\n```\n**Commit**: [SHA]\n<phase_complete>true</phase_complete>\n```\n\nIf blocked (requirements unclear):\n```\n<phase_blocked>\nreason: [what's unclear]\nneeds: [what clarification is needed]\n</phase_blocked>\n```\n\n\n## Response\n\nThe specification has been saved to the database (4682 characters). Since task specs are stored in SQLite (not git-tracked files), there is no commit to make.\n\n**Spec saved**: TASK-250 spec stored in `.orc/orc.db` (4682 bytes)\n<phase_complete>true</phase_complete>\n\n---\nTokens: 2478550 input, 6157 output, 101073 cache_creation, 2377447 cache_read\nComplete: true\nBlocked: false\n"
      timestamp: 1768628597
    - id: 201
      taskid: TASK-250
      phase: test
      iteration: 1
      role: combined
      content: |
        # test - Iteration 1

        ## Prompt

        Test and review the implementation:

        **Task**: Fix: Heartbeat goes stale during long phases causing false orphan detection
        **Category**: {{TASK_CATEGORY}}

        ## Specification

        # Specification: Fix: Heartbeat goes stale during long phases causing false orphan detection

        ## Problem Statement
        [1-2 sentences]

        ## Success Criteria
        - [ ] [Criterion 1]
        - [ ] [Criterion 2]

        ## Testing Requirements
        - [ ] [Test 1]
        - [ ] [Test 2]

        ## Scope
        ### In Scope
        - [Item]
        ### Out of Scope
        - [Item]

        ## Technical Approach
        [Brief implementation plan]

        ### Files to Modify
        - [file]: [change]

        ## [Category-Specific Section]
        [Include appropriate section based on category]

        ## Instructions

        1. Run the full test suite
        2. Verify all Testing Requirements from spec are satisfied
        3. Review code for quality issues
        4. Check for edge cases and security issues
        5. Fix any problems found

        ### Verification Against Spec
        Go through each Success Criterion and Testing Requirement from the spec
        and verify it's satisfied.

        Keep iterating until all tests pass and code quality is acceptable.

        After completing, commit:
        ```bash
        git add -A
        git commit -m "[orc] TASK-250: test - completed"
        ```

        When done, output:
        ```
        **Commit**: [SHA]
        <phase_complete>true</phase_complete>
        ```


        ## Response

        **Summary of Test and Review:**

        ## Implementation Review

        The implementation correctly adds heartbeat support to `FinalizeExecutor` to prevent false orphan detection during long operations:

        1. **New field**: `heartbeatUpdater func()` added to `FinalizeExecutor` struct
        2. **New option**: `WithFinalizeHeartbeatUpdater(fn func())` for configuring the callback
        3. **New method**: `updateHeartbeat()` that safely calls the callback (nil-safe)
        4. **Integration points**: `updateHeartbeat()` called at 7 key locations during execution:
           - Before fetch, divergence check, sync, tests, test fixes, risk assessment, and commit
        5. **AI operations**: `resolveConflicts` and `tryFixTests` now use `StreamTurnWithProgress` with heartbeat support

        ## Test Coverage

        - `TestWithFinalizeHeartbeatUpdater` - Option function works correctly
        - `TestFinalizeExecutor_updateHeartbeat` - Nil-safe and invokes callback
        - `TestFinalizeExecutor_updateHeartbeat_MultipleCalls` - Repeated calls work
        - `TestFinalizeExecutor_HeartbeatConfigPropagation` - Config + callback together

        ## Fix Applied

        Fixed missing `time` import in `finalize_test.go` which was needed for `TestFinalizeExecutor_HeartbeatConfigPropagation`.

        **Commit**: ed64df87
        <phase_complete>true</phase_complete>

        ---
        Tokens: 2939160 input, 6074 output, 84255 cache_creation, 2854868 cache_read
        Complete: true
        Blocked: false
      timestamp: 1768628597
gate_decisions:
    - id: 130269
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130270
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130271
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130272
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130273
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130274
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130275
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130285
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130286
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130287
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130288
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130289
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130290
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130291
      taskid: TASK-250
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T17:51:30-06:00
    - id: 130276
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130277
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130278
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130279
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130280
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130292
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130293
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130294
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130295
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130296
      taskid: TASK-250
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:09:55-06:00
    - id: 130281
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130282
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130283
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130297
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130298
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130299
      taskid: TASK-250
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:15:35-06:00
    - id: 130284
      taskid: TASK-250
      phase: docs
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:17:40-06:00
    - id: 130300
      taskid: TASK-250
      phase: docs
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-15T18:17:40-06:00
