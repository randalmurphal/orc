version: 2
exported_at: 2026-01-16T23:27:38.836246986-06:00
task:
    id: TASK-197
    title: Add process/resource tracking to diagnose system freezes
    description: "## Problem\nSystem freezes occur across Linux, Mac, and WSL after running multiple orc tasks. Suspected cause: orphaned MCP server processes (Playwright, browsers) not being cleaned up when Claude CLI sessions end.\n\n## Root Cause Analysis\nWhen orc runs a task:\n```\norc (Go process)\n└── Claude CLI (spawned by llmkit)\n    └── MCP servers (Playwright, etc)\n        └── Chromium browsers\n```\n\nllmkit kills Claude CLI on session.Close(), but doesn't kill the process GROUP - leaving MCP servers and browsers as orphans that accumulate.\n\n## Solution: Add Resource Tracking\n\n### 1. Process Tree Tracking\n- Before task: snapshot running processes\n- After task: compare, log any new orphans\n- Track: PID, PPID, command, memory usage\n\n### 2. Memory Tracking  \n- Log memory before/after each phase\n- Alert if memory grows significantly between tasks\n\n### 3. Child Process Cleanup (llmkit fix)\n- Use process groups (Setpgid) when spawning Claude CLI\n- Kill entire process group on Close(), not just parent\n\n### 4. MCP Server Lifecycle Logging\n- Log when MCP servers start/stop\n- Detect orphaned MCP processes\n\n## Files to Modify\n- internal/executor/session_adapter.go - Add pre/post tracking\n- internal/executor/executor.go - Add memory logging\n- llmkit/claude/session/session.go - Process group kill (separate PR)\n\n## Success Criteria\n- Logs show process counts before/after tasks\n- Orphaned processes are detected and logged\n- Memory growth is tracked between tasks"
    weight: medium
    status: completed
    current_phase: docs
    branch: orc/TASK-197
    queue: active
    priority: critical
    category: bug
    created_at: 2026-01-14T20:53:29-06:00
    updated_at: 2026-01-14T21:22:56-06:00
    started_at: 2026-01-14T21:09:51-06:00
    completed_at: 2026-01-14T21:22:56-06:00
    metadata:
        pr_url: https://github.com/randalmurphal/orc/pull/99
plan:
    version: 1
    task_id: TASK-197
    weight: medium
    description: Medium task - spec, implement, test, docs with clear success criteria
    phases:
        - id: implement
          name: implement
          prompt: |
            Implement the task according to the specification:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            {{INITIATIVE_CONTEXT}}

            ## Specification

            {{SPEC_CONTENT}}

            {{RETRY_CONTEXT}}

            ## Instructions

            1. Review the spec's success criteria - these are your acceptance criteria
            2. Implement the required changes following the technical approach
            3. Write/update tests alongside code (as specified in Testing Requirements)
            4. Run tests and fix any failures
            5. Self-review against success criteria before completing

            ### Self-Review Checklist
            - [ ] All success criteria from spec addressed
            - [ ] All testing requirements satisfied
            - [ ] Scope boundaries respected (no extra features)
            - [ ] Error handling complete
            - [ ] Code follows project patterns

            Keep iterating until implementation is complete and tests pass.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: implement - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - spec
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: 166be38bdf9b2ba0d4b0e5582d451f196f77fd94
        - id: test
          name: test
          prompt: |
            Test and review the implementation:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            ## Specification

            {{SPEC_CONTENT}}

            ## Instructions

            1. Run the full test suite
            2. Verify all Testing Requirements from spec are satisfied
            3. Review code for quality issues
            4. Check for edge cases and security issues
            5. Fix any problems found

            ### Verification Against Spec
            Go through each Success Criterion and Testing Requirement from the spec
            and verify it's satisfied.

            Keep iterating until all tests pass and code quality is acceptable.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: test - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - implement
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: d4cae390c66a7494108ffb91b3ceb0df135036fd
        - id: docs
          name: docs
          prompt: |
            Update documentation for:

            **Task**: {{TASK_TITLE}}
            **Category**: {{TASK_CATEGORY}}

            ## Specification

            {{SPEC_CONTENT}}

            ## Instructions

            1. Update any relevant documentation files
            2. Ensure CLAUDE.md reflects the changes if applicable
            3. Add/update code comments where needed
            4. Update README if user-facing changes were made

            Keep iterating until documentation is complete.

            After completing, commit:
            ```bash
            git add -A
            git commit -m "[orc] {{TASK_ID}}: docs - completed"
            ```

            When done, output:
            ```
            **Commit**: [SHA]
            <phase_complete>true</phase_complete>
            ```
          depends_on:
            - test
          gate:
            type: auto
          checkpoint: true
          status: completed
          commit_sha: c0aa1f033549c48c5e2e100e7a5728816fd8c399
state:
    task_id: TASK-197
    current_phase: docs
    current_iteration: 0
    status: completed
    started_at: 2026-01-14T21:09:51-06:00
    updated_at: 0001-01-01T00:00:00Z
    phases:
        docs:
            status: completed
            started_at: 2026-01-14T21:19:48-06:00
            completed_at: 2026-01-14T21:22:56-06:00
            iterations: 1
            commit_sha: c0aa1f033549c48c5e2e100e7a5728816fd8c399
            tokens:
                input_tokens: 2615133
                output_tokens: 8367
                total_tokens: 0
        implement:
            status: completed
            started_at: 2026-01-14T21:09:53-06:00
            completed_at: 2026-01-14T21:16:09-06:00
            iterations: 1
            commit_sha: 166be38bdf9b2ba0d4b0e5582d451f196f77fd94
            tokens:
                input_tokens: 3809701
                output_tokens: 14929
                total_tokens: 0
        spec:
            status: completed
            started_at: 2026-01-14T21:03:28-06:00
            completed_at: 2026-01-14T21:04:32-06:00
            iterations: 1
            commit_sha: 85d2fcb061ac0026247a9a68196c479568b27e57
            tokens:
                input_tokens: 425855
                output_tokens: 2643
                total_tokens: 0
        test:
            status: completed
            started_at: 2026-01-14T21:16:09-06:00
            completed_at: 2026-01-14T21:19:48-06:00
            iterations: 1
            commit_sha: d4cae390c66a7494108ffb91b3ceb0df135036fd
            tokens:
                input_tokens: 2353552
                output_tokens: 6772
                total_tokens: 0
    gates:
        - phase: spec
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T21:04:32-06:00
        - phase: implement
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T21:16:09-06:00
        - phase: test
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T21:19:48-06:00
        - phase: docs
          gate_type: auto
          approved: true
          reason: auto-approved on success
          timestamp: 2026-01-14T21:22:56-06:00
    tokens:
        input_tokens: 0
        output_tokens: 0
        total_tokens: 0
    cost:
        total_cost_usd: 0
gate_decisions:
    - id: 64
      taskid: TASK-197
      phase: spec
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T21:04:32-06:00
    - id: 65
      taskid: TASK-197
      phase: implement
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T21:16:09-06:00
    - id: 66
      taskid: TASK-197
      phase: test
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T21:19:48-06:00
    - id: 67
      taskid: TASK-197
      phase: docs
      gatetype: auto
      approved: true
      reason: auto-approved on success
      decidedby: ""
      decidedat: 2026-01-14T21:22:56-06:00
