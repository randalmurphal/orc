# Project Knowledge

Patterns, gotchas, and decisions learned during development. This file is auto-updated by orc during task execution.

## Patterns Learned

| Pattern | Description | Source |
|---------|-------------|--------|
| Branch sync before completion | Task branches rebase onto target before PR to catch conflicts early | TASK-019 |
| Atomic status+phase updates | Set `current_phase` atomically with `status=running` to avoid UI timing issues (task shows in wrong column) | TASK-057 |
| Plan regeneration on weight change | When task weight changes, plan.yaml auto-regenerates with new phases; completed/skipped phases preserved if they exist in both plans | TASK-003 |
| Artifact detection for phase skip | Before running phases, check if artifacts exist (spec.md, research.md, docs.md) and offer to skip; use `--auto-skip` for non-interactive mode | TASK-004 |
| Project selection persistence | URL param (`?project=xxx`) takes precedence over localStorage; enables shareable links and browser back/forward navigation | TASK-009 |
| Running task visual indicator | Running tasks show pulsing border + gradient background; placed in column matching `current_phase` from state.yaml | TASK-006 |
| Running task sort priority | Running tasks sort to top of their column before priority sorting; ensures active work is always visible | TASK-028 |
| Live transcript modal | Click running task to open LiveTranscriptModal with streaming output, token tracking, and connection status; uses WebSocket `transcript` events for real-time updates | TASK-012 |
| Worktree-aware project root | `config.FindProjectRoot()` resolves main repo with `.orc/tasks` when running from worktree; uses git common-dir to find main repo | TASK-025 |
| Initiative-task bidirectional sync | Setting `initiative_id` on a task auto-adds it to the initiative's task list; deleting a task removes it from its initiative | TASK-060 |
| Initiative sidebar filtering | Sidebar Initiatives section filters Board/Tasks; URL param (`?initiative=xxx`) takes precedence over localStorage; selection pushes to browser history for back/forward navigation | TASK-061 |
| Initiative filter dropdown | InitiativeDropdown component in filter bars syncs with sidebar; includes "All initiatives", "Unassigned" (tasks with no initiative_id), and initiative list with task counts; uses UNASSIGNED_INITIATIVE constant for special filtering | TASK-062 |
| Editable settings via UI | All settings (Claude Code global/project, orc config) editable through web UI; separate API endpoints for global (`PUT /api/settings/global`) vs project (`PUT /api/settings`) scope | TASK-033 |
| Browser-safe keyboard shortcuts | Web UI uses `Shift+Alt` modifier (on Mac) for global shortcuts instead of Cmd/Ctrl to avoid browser conflicts with Cmd+K, Cmd+N, etc. | TASK-037 |
| Task dependency validation | `blocked_by` and `related_to` fields validated on create/update: references must exist, no self-references, circular deps rejected; computed fields (`blocks`, `referenced_by`) populated on load | TASK-070 |
| Blocking enforcement on run | CLI and API check `blocked_by` for incomplete blockers before running; CLI prompts in interactive mode, refuses in quiet mode without `--force`; API returns 409 Conflict with blocker details, accepts `?force=true` to override | TASK-071 |
| Dependency visualization CLI | `orc deps` shows dependencies with multiple views: standard (single task), `--tree` (recursive), `--graph` (ASCII flow chart); `orc status` shows BLOCKED/READY sections for dependency-aware task overview | TASK-077 |
| Finalize phase with escalation | Finalize phase syncs branch with target, resolves conflicts via AI, runs tests, and assesses risk; escalates to implement phase if >10 conflicts or >5 test failures persist | TASK-089 |
| Initiative-to-initiative dependencies | Initiatives support `blocked_by` field for ordering; `blocks` computed on load; `orc initiative list/show` displays blocked status; `orc initiative run --force` overrides blocking | TASK-075 |
| Initiative detail page | `/initiatives/:id` route manages tasks and decisions within an initiative; supports task linking/unlinking, decision recording with rationale, status management (draft/active/completed/archived), and progress tracking | TASK-066 |
| Initiative dependency graph | Graph tab in initiative detail shows visual DAG of task dependencies; uses Kahn's algorithm for topological layout; interactive zoom/pan, click-to-navigate, PNG export; API: `GET /api/initiatives/:id/dependency-graph` | TASK-076 |
| PR status polling | Background poller (60s interval, 30s rate limit) tracks PR status via hosting provider API (GitHub or GitLab); status derived from PR state + reviews (changes_requested > approved > pending_review); stores in task.yaml `pr` field | TASK-090 |
| Board swimlane view | Optional "By Initiative" view groups tasks into horizontal swimlanes; toggle persists in localStorage; disabled when initiative filter active; click task card to navigate to detail | TASK-065 |
| Auto-trigger finalize on approval | In `auto` profile, finalize phase auto-triggers when PR is approved; controlled by `completion.finalize.auto_trigger_on_approval`; respects 30s rate limit, skips trivial tasks | TASK-091 |
| Finalize UI components | FinalizeModal for progress/results; TaskCard shows finalize button (completed), progress bar (finalizing), merge info (finished); WebSocket `finalize` events for real-time updates | TASK-094 |
| Auto-approve PRs in auto mode | In `auto`/`fast` profiles, PRs are auto-approved after verifying CI passes; uses Provider.ApprovePR() via hosting provider API with summary comment; `safe`/`strict` profiles require human approval | TASK-099 |
| Initiative database storage | Initiatives stored in SQLite (`initiatives`, `initiative_tasks`, `initiative_decisions`, `initiative_dependencies` tables); `initiative.Save()` writes directly to database; CLI operations auto-commit changes | TASK-097 |
| CLAUDE.md auto-merge | During git sync, conflicts in knowledge section (within `orc:knowledge:begin/end` markers) are auto-resolved if purely additive (both sides add new table rows); rows combined and sorted by TASK-XXX source ID; complex conflicts (overlapping edits) fall back to manual resolution | TASK-096 |
| Task database storage | Tasks stored in SQLite (`tasks`, `phases`, `plans`, `specs` tables); all task operations write directly to database; config changes and prompt files still tracked in git | TASK-153 |
| CI wait and auto-merge | After finalize, poll Provider.GetCheckRuns() until CI passes (30s interval, 10m timeout), then merge via Provider.MergePR(); bypasses hosting provider auto-merge features (no branch protection needed); `auto`/`fast` profiles only | TASK-151 |
| Config and prompt auto-commit | Configuration files (`.orc/config.yaml`) and prompt templates (`.orc/prompts/`) auto-commit to git on modification; task and initiative data stored in SQLite (not git-tracked) | TASK-193 |
| WebSocket E2E event injection | Use Playwright's `routeWebSocket` to intercept connections and inject events via `ws.send()`; captures real WebSocket, forwards messages bidirectionally, allows test-initiated events; framework-agnostic approach for testing real-time UI updates | TASK-157 |
| Visual regression baselines | Separate Playwright project (`visual`) with 1440x900 @2x viewport, disabled animations, masked dynamic content (timestamps, tokens); use `--update-snapshots` to regenerate after intentional UI changes; baselines in `web/e2e/__snapshots__/` | TASK-159 |
| Keyboard shortcut E2E testing | Test multi-key sequences (g+d, g+t) with sequential `page.keyboard.press()` calls; test Shift+Alt modifiers; verify input field awareness (shortcuts disabled when typing); use `.selected` class for task navigation; 13 tests in `web/e2e/keyboard-shortcuts.spec.ts` | TASK-160 |
| Finalize workflow E2E testing | Test finalize modal states (not started, running, completed, failed) via WebSocket event injection; covers button visibility on completed tasks, modal content, progress bar with step labels, success/failure results, retry option; 10 tests in `web/e2e/finalize.spec.ts` | TASK-161 |
| Sync on start for stale worktrees | Before execution starts, sync task branch with target to catch conflicts from parallel tasks; `sync_on_start: true` (default) rebases onto latest target so implement phase sees current code; disable if you need isolation from concurrent changes | TASK-194 |
| Resource tracking for orphan detection | Executor snapshots processes before/after task; compares to detect orphaned MCP processes (playwright, chromium); logs warnings with process details and memory growth; configure via `diagnostics.resource_tracking` in config | TASK-197 |
| E2E sandbox isolation | E2E tests MUST run against isolated sandbox project in `/tmp`, not production; `global-setup.ts` creates sandbox with test tasks/initiatives, `global-teardown.ts` removes it; test files import from `./fixtures` (not `@playwright/test`) to auto-select sandbox; tests that bypass fixtures will corrupt real task data | TASK-201 |
| React migration complete | Frontend migrated from Svelte 5 to React 19; archived Svelte codebase at `web-svelte-archive/`, moved React to `web/`; E2E tests use framework-agnostic selectors (role, text, CSS classes) | TASK-180 |
| Resolve with worktree cleanup | `orc resolve` detects worktree state (dirty, rebase/merge in progress, conflicts) and offers `--cleanup` to abort git ops and discard changes; `--force` skips checks; worktree state recorded in task metadata for audit | TASK-221 |
| Multi-table DB transactions | Operations spanning multiple tables (task+dependencies, state+phases, initiative+decisions+tasks) wrapped in `RunInTx()` for atomicity; transaction-aware functions (`SaveTaskTx`, `SavePhaseTx`, etc.) use `TxOps` context; rollback on any error ensures consistency | TASK-223 |
| Button primitive for board components | All board buttons (TaskCard, QueuedColumn, Swimlane, ViewModeDropdown) use Button component with `variant="ghost" size="sm"` for consistency; preserve existing CSS classes via `className` prop for backwards compatibility; icon-only buttons require `aria-label` | TASK-207 |
| Button primitive migration | Dashboard and layout components migrated from raw `<button>` to unified Button component; preserve existing CSS class names via `className` prop; use `variant="ghost"` for minimal styling, `variant="primary"` for primary actions | TASK-209 |
| FinalizeTracker cleanup | `finalizeTracker` (in-memory map of finalize operations) auto-cleans completed/failed entries after 5 min retention; `startCleanup()` runs in background goroutine triggered by `Server.StartContext()`; running/pending entries never cleaned (active operations); prevents unbounded memory growth from completed finalize operations | TASK-225 |
| Initiative batch loading | `LoadAllInitiatives()` uses batch queries (`GetAllInitiativeDecisions`, `GetAllInitiativeTaskRefs`, etc.) to fetch all related data in 4 queries instead of N+1 per initiative; batch methods return maps keyed by initiative ID; `GetAllInitiativeTaskRefs()` JOINs tasks table to include title/status | TASK-234 |
| WorkerPool self-cleanup | Workers remove themselves from `WorkerPool.workers` map immediately on completion/failure via defer in `run()`; frees capacity without waiting for next orchestrator tick; handlers check `GetWorker()` first (idempotent - worker may have self-cleaned) | TASK-238 |
| Finalize goroutine cancellation | `runFinalizeAsync` goroutines use contexts derived from `Server.serverCtx`; `finalizeTracker.cancels` map stores cancel functions; server shutdown calls `cancelAll()` to terminate running operations; goroutines check `ctx.Err()` at key points to exit cleanly | TASK-226 |
| Scheduler map cleanup | `Scheduler.MarkCompleted()` cleans up `taskDeps` immediately and prunes `completed` entries no longer needed by queued/running tasks; `RemoveTask()` available for failed tasks that won't be retried; prevents unbounded memory growth in long-running orchestrator | TASK-239 |
| Context propagation in DatabaseBackend | `SaveTaskCtx`, `SaveStateCtx`, `SaveInitiativeCtx` methods propagate context through `RunInTx` to `TxOps`; enables request cancellation and timeouts for database operations; non-context methods use `context.Background()` for backward compatibility | TASK-240 |
| Worker.run() iterative phase loop | `Worker.run()` uses `for` loop (not recursion) to execute phases sequentially; eliminates stack growth risk for tasks with many phases; loop continues until all phases complete, context cancelled, or error occurs | TASK-230 |
| Git mutex for compound operations | `Git` struct has mutex protecting compound operations (worktree creation, checkpoint, rebase, conflict detection); individual git commands are process-atomic and don't need locking; worktree instances get independent mutexes for parallel execution | TASK-235 |
| Finalize tracker atomic tryStart | `finalizeTracker.tryStart()` atomically checks and sets finalize state to prevent TOCTOU race; returns existing state if pending/running, allows replacement if completed/failed (retry); eliminates race where concurrent requests both pass the check and both start finalize | TASK-236 |
| Worker process group cleanup | Workers set `Setpgid: true` on commands to create process groups; `Stop()` kills entire process group via negative PID (`syscall.Kill(-pid, SIGKILL)`); prevents orphaned MCP processes (playwright, chromium) after worker shutdown; platform-specific files: `worker_unix.go` (real), `worker_windows.go` (no-op) | TASK-222 |
| TaskCard Radix DropdownMenu | TaskCard quick menu uses `@radix-ui/react-dropdown-menu` for accessible menu; trigger wraps Button with `DropdownMenu.Trigger asChild`; content portals via `DropdownMenu.Portal`; uses `data-highlighted` for keyboard focus, `onCloseAutoFocus` prevents refocus; CSS class `.quick-menu-dropdown` for styling | TASK-212 |
| Test worker limits for parallel tasks | Playwright (4 workers) and Vitest (4 threads) limit parallelism to prevent OOM when multiple orc tasks run tests concurrently; without limits, 3 parallel tasks on 16 cores could spawn 48 browser/test processes | TASK-253 |
| Filter dropdown Radix migration | InitiativeDropdown, ViewModeDropdown, DependencyDropdown use Radix Select; ExportDropdown uses Radix DropdownMenu (action menu pattern); null values mapped to internal string constants since Radix Select requires strings; provides keyboard nav, typeahead, Home/End, ARIA | TASK-213 |
| TabNav Radix Tabs migration | TabNav uses `@radix-ui/react-tabs` with render prop pattern for tab content; Tabs.Root wraps entire component, Tabs.List contains Tabs.Trigger elements, Tabs.Content wraps the children render prop result; provides arrow key navigation, Home/End, focus management, automatic ARIA; CSS uses `data-state='active'` for active tab styling | TASK-214 |
| Radix Tooltip component | `Tooltip` wraps `@radix-ui/react-tooltip` with consistent styling; `TooltipProvider` at App.tsx root provides global delay config (300ms); supports rich content (JSX), controlled mode, placement, arrow; portals to `document.body`; use instead of native `title` for accessibility and consistent styling | TASK-215 |
| UI primitives E2E testing | Three test files validate Radix integration: `ui-primitives.spec.ts` (22 tests: Button, DropdownMenu, Select, Tabs, Tooltip), `radix-a11y.spec.ts` (17 tests: keyboard navigation, focus trap, ARIA attributes), `axe-audit.spec.ts` (8 tests: WCAG 2.1 AA compliance via axe-core); selector strategy prioritizes role/aria-label over CSS classes | TASK-216 |
| Branch resolution 5-level hierarchy | `ResolveTargetBranch()` resolves target branch with priority: task override -> initiative branch -> developer staging -> project config -> "main"; each level can override lower levels; source tracking via `ResolveBranchSource()` for debugging | branch-targeting |
| Branch lazy creation | Target branches (initiative, staging) created on first task run via `EnsureTargetBranchExists()` in setup; default branches (main, master, develop) never auto-created; prevents orphan branches from unused initiatives | branch-targeting |
| Branch registry tracking | All orc-managed branches tracked in `branches` table with type (initiative/staging/task), owner_id, status (active/merged/stale/orphaned), timestamps; enables `orc branches list/cleanup` for lifecycle management | branch-targeting |
| Initiative branch auto-merge | When all initiative tasks complete and initiative has `BranchBase`, auto-merge to target branch; `auto`/`fast` profiles auto-merge after CI, `safe`/`strict` leave PR for human review; tracks `MergeStatus` (none/pending/merged/failed) | branch-targeting |
| Developer staging workflow | Personal staging branches via `developer.staging_branch` + `staging_enabled` in personal config; `orc staging status/sync/enable/disable` commands; staging takes precedence over project default but yields to initiative branches | branch-targeting |
| Clickable task cards | TaskCard removed drag-and-drop; clicking anywhere (except action buttons) navigates to task detail; running tasks open LiveTranscriptModal; uses `cursor: pointer` and `role="button"` for accessibility | TASK-277 |
| User agent loading in headless sessions | Session managers configured with `WithSettingSources([]string{"project", "local", "user"})` to load user-defined agents from `~/.claude/agents/`; without "user" source, agents like Reviewer and Security-Auditor aren't available in headless execution | review-phase |
| Dual template rendering paths | Two template paths must stay in sync: `template.go:RenderTemplate()` (session-based) and `flowgraph_nodes.go:renderTemplate()` (flowgraph); when adding variables, update BOTH files; `processReviewConditionals()` must be called in both for `{{#if REVIEW_ROUND_N}}` blocks | review-phase |
| Worktree cleanup by path | Executor stores actual worktree path and uses `CleanupWorktreeAtPath()` instead of reconstructing from task ID; handles initiative-prefixed worktrees (e.g., `feature-auth-TASK-001`) that don't match default naming | TASK-282 |
| Stale worktree pruning on startup | Server calls `gitOps.PruneWorktrees()` on startup to clean git's internal worktree tracking for directories deleted without `git worktree remove` (crashed processes, manual deletion) | TASK-282 |
| Spec database-only storage | Spec content stored exclusively in database (not filesystem) to avoid merge conflicts in worktrees; `SavePhaseArtifact()` skips spec phase, `SaveSpecToDatabase()` is sole save mechanism; `WithSpecFromDatabase()` loads spec for templates; `ArtifactDetector` uses `NewArtifactDetectorWithBackend` to check database first | TASK-283 |
| Session ID only with persistence | Custom session IDs (e.g., `orc-TASK-001-implement`) only passed to Claude CLI when `Persistence: true`; Claude CLI expects UUIDs it generates, so ephemeral sessions skip `WithSessionID()` to avoid "Invalid session ID" errors | TASK-286 |
| Resolve blocked task guidance | `orc resolve` on blocked task provides actionable error with suggested commands (`orc approve` for gate approval, `orc resume` for resuming execution); distinguishes from generic "wrong status" errors; includes task ID in suggestions for copy-paste convenience | TASK-288 |
| Spec phase progress indication | Spec phase has two distinct activity states: `spec_analyzing` (reading codebase, researching patterns) and `spec_writing` (generating specification); CLI shows "Analyzing codebase..." / "Writing specification..." messages; WebSocket broadcasts `activity` events with phase-specific states; TaskCard shows activity label under phase name; heartbeats continue during spec execution | TASK-244 |
| Orphan detection prioritizes PID | `CheckOrphaned()` prioritizes PID check over heartbeat staleness - a live PID always indicates a healthy task regardless of heartbeat age; heartbeat staleness only provides additional context when PID is dead; `HeartbeatRunner` updates heartbeats every 2 minutes during phase execution for defense-in-depth | TASK-291 |
| Log level classification for expected failures | PR label errors and auto-merge config errors (GitHub returns ErrAutoMergeNotSupported) log at DEBUG; auth errors log at WARN (actionable); missing spec warnings only for large/greenfield weights; keeps normal operation quiet while surfacing actionable issues | TASK-289 |
| Initiative decision ID namespace | Decision IDs (DEC-001, DEC-002, etc.) are scoped per-initiative, not global; composite primary key `(id, initiative_id)` in `initiative_decisions` table; `AddDecision()` generates ID from `len(i.Decisions)+1`, so each initiative's first decision is DEC-001 | TASK-414 |
| Streaming transcript persistence | `TranscriptBuffer` in executor package batches transcript lines (50 lines or 5 seconds) for database persistence; attached to `EventPublisher` via `SetBuffer()`; chunks accumulated until newline then persisted; `Close()` flushes remaining on phase/executor completion; uses background context with 30s timeout to ensure writes complete even on cancellation | TASK-401 |
| Merge retry with rebase on 405 | `MergePR()` retries on HTTP 405 "Base branch was modified" errors (up to 3 attempts with exponential backoff: 2s, 4s, 8s); rebases branch onto target before each retry; merge via hosting provider API; merge failures block task completion with `blocked_reason=merge_failed` instead of false positive "completed" | TASK-437 |
| PhaseMax timeout enforcement | `ExecutePhase()` wrapped with `executePhaseWithTimeout()` to enforce `PhaseMax` config (default 60m); `FinalizeTask()` also respects timeout; `PhaseMax=0` disables timeout; timeout produces `phaseTimeoutError` which marks task as failed (resumable via `orc resume`); logs warnings at 50% and 75% thresholds; distinguishes phase timeout from parent context cancellation | TASK-439, TASK-444 |
| Worktree branch verification on reuse | `cleanWorktreeState()` verifies worktree is on expected task branch before reuse; if wrong branch detected, logs warning and switches via `CheckoutSafe()`; also verifies branch exists before checkout; prevents review seeing no changes (diffing main against main) | TASK-392 |
| Hook injection failure is fatal | `InjectWorktreeHooks()` failure now returns error instead of warning; worktrees without safety hooks lack branch protection; error message: "failed to inject worktree safety hooks (worktree not safe to use without branch protection)" | TASK-392 |
| No silent failures in git state checks | `IsRebaseInProgress()` and `IsMergeInProgress()` errors logged at WARN level instead of silently swallowed; `IsClean()` errors logged at DEBUG and original error included if `DiscardChanges()` also fails | TASK-392 |
| Event persistence with PersistentPublisher | `PersistentPublisher` wraps `MemoryPublisher` using composition pattern; broadcasts to WebSocket first (real-time), buffers events (10 or 5s), flushes to `event_log` table in batch transaction; phase completion triggers immediate flush; tracks phase start times for `duration_ms` calculation; DB failures logged but don't block WebSocket broadcast | TASK-393 |
| Cost tracking with model differentiation | `recordCostToGlobal()` called after each phase completion logs to global database with model (opus/sonnet/haiku), cache tokens, iteration, duration_ms; `DetectModel()` normalizes model IDs; `GetCostByModel()` and `GetCostTimeseries()` for analytics; budget tracking via `GetBudget()`/`SetBudget()`/`GetBudgetStatus()` | TASK-406 |
| Real-time file change events | `FileWatcher` polls git diff every 10 seconds during task execution, comparing HEAD against target branch merge-base; publishes `files_changed` WebSocket event with per-file additions/deletions; deduplicates via state hash to only emit when changes detected; started by `ExecuteTask()` after worktree setup; stopped before cleanup | TASK-470 |
| Auto-migration for stale plans | `orc run` calls `checkAndMigrateStalePlan()` before execution; detects staleness via version mismatch, phase sequence change, or inline prompts (legacy); `MigratePlan()` preserves completed/skipped phases; manual migration via `orc migrate plans --all`; API auto-migrates before task execution too | TASK-498 |
| Cursor-based transcript pagination | `useTranscripts` hook uses cursor-based pagination with `getTranscriptsPaginated()` API; maintains forward/backward cursors for bidirectional infinite scroll; streaming lines stored temporarily then merged on periodic refresh (5s interval); enables viewing 15-30MB transcripts without loading all into memory | TASK-404 |
| Virtual scrolling for large lists | `TranscriptVirtualList` uses windowing technique (only renders visible items + overscan); `ResizeObserver` tracks container height; measured heights cached in `Map<number, number>` for accurate positioning; threshold at 100 items triggers virtual mode; handles dynamic item heights via estimate + measurement | TASK-404 |
| Streaming + DB sync pattern | `TranscriptViewer` accumulates WebSocket `transcript` events in `streamingLines` state; periodic refresh (5s) calls API to sync persisted data and clears streaming buffer; provides immediate feedback while ensuring data consistency; auto-scroll follows new content when enabled | TASK-404 |
| Weight-to-workflow auto-assignment | CreateTask (API and CLI) auto-assigns `workflow_id` based on `weight` when not explicitly provided: trivial竊段mplement-trivial, small竊段mplement-small, medium竊段mplement-medium, large竊段mplement-large; explicit `workflow_id` takes precedence; enables running tasks without manually specifying workflow | TASK-590 |
| Multi-provider hosting | Provider interface abstracts GitHub/GitLab; `EnableAutoMerge` returns `ErrAutoMergeNotSupported` on GitHub (no GraphQL), works on GitLab; `GetPRComment` needs `prNumber` for GitLab Notes API; commit templates use `renderCommitTemplate()` with `{{TASK_ID}}`, `{{TASK_TITLE}}`, `{{TASK_BRANCH}}`; SHA verification prevents stale merges | hosting-enhancement |

## Known Gotchas

| Issue | Resolution | Source |
|-------|------------|--------|
| PR labels in config don't exist on repo | Orc logs at DEBUG level and creates PR without labels (graceful degradation, silent in normal operation) | TASK-015, TASK-289 |
| `go:embed` fails without static dir | Run `make test` (creates placeholder) or `mkdir -p internal/api/static` | TASK-016 |
| Tests fail with `go.work` | Use `GOWORK=off go test` or `make test` | TASK-016 |
| Raw `InputTokens` appears misleadingly low | Use `EffectiveInputTokens()` which adds cached tokens to get actual context size | TASK-010 |
| Task stuck in "running" after crash | Use `orc resume TASK-XXX` (auto-detects orphaned state) or `--force` to override | TASK-046 |
| Failed task can't be resumed | Fixed: `orc resume` now supports failed tasks, resuming from last incomplete phase | TASK-025 |
| Setup errors (worktree creation) failed silently | Fixed: Errors now always display even in quiet mode, task status set to failed | TASK-044 |
| Web UI shows "No project selected" | Select a project via `Shift+Alt+P` - server can run from any directory | TASK-005 |
| Auto-merge fails with worktree error | Fixed: Uses hosting provider API for merge instead of `gh pr merge` CLI which tried to checkout target branch locally | TASK-196 |
| Finished tasks still blocked dependents | Fixed: `GetIncompleteBlockers()` now uses `isDone()` helper to recognize both `completed` and `finished` statuses as done | TASK-199 |
| Re-running completed task fails to push | Fixed: Push now detects non-fast-forward errors (diverged remote) and automatically retries with `--force-with-lease` | TASK-198 |
| Sync fails with '0 files in conflict' error | Fixed: `RebaseWithConflictCheck()` now only returns `ErrMergeConflict` when actual conflicts detected; other rebase failures (dirty tree, rebase in progress) return the raw error | TASK-201 |
| PRPoller.Stop() panics on double call | Fixed: `Stop()` now uses `sync.Once` to guard channel close; safe to call multiple times from concurrent shutdown paths | TASK-231 |
| Total time shows 292 years | Fixed: `State.Elapsed()` method checks for zero `StartedAt` before calling `time.Since()`; returns 0 for uninitialized states instead of Unix epoch difference | TASK-243 |
| Total time shows 0s for completed tasks | Fixed: `StartExecution()` now sets `State.StartedAt` if not already set; previously only set `Execution.StartedAt`, leaving `State.StartedAt` zero for states loaded from database; preserves original start time for resumed tasks | TASK-284 |
| Running tasks falsely flagged as orphaned | Fixed: `SaveState()` now persists `ExecutionInfo` (PID, hostname, heartbeat) to database; `LoadState()` restores it; orphan detection works correctly across orc restarts | TASK-242 |
| SaveTask overwrites executor fields | Fixed: `SaveTask()` now preserves executor fields (PID, hostname, heartbeat) when updating task metadata; prevents false orphan detection when CLI/API updates a running task | TASK-249 |
| detectConflictsViaMerge left worktree in merge state | Fixed: Cleanup (`merge --abort` + `reset --hard`) now uses `defer` to guarantee execution even on error/panic; idempotent cleanup is safe even if merge wasn't started | TASK-229 |
| Resume blocked by dirty worktree state | Fixed: `SetupWorktree` now calls `cleanWorktreeState` when reusing existing worktree; aborts in-progress rebase/merge and discards uncommitted changes; enables resume after task failure without manual cleanup | TASK-247 |
| Template variables not substituted in prompts | Fixed: Flowgraph executor's `renderTemplate()` now includes all variables from standard `RenderTemplate()`: `{{TASK_CATEGORY}}`, `{{INITIATIVE_CONTEXT}}`, `{{REQUIRES_UI_TESTING}}`, `{{SCREENSHOT_DIR}}`, `{{TEST_RESULTS}}`, `{{COVERAGE_THRESHOLD}}`, `{{REVIEW_ROUND}}`, `{{REVIEW_FINDINGS}}`, `{{VERIFICATION_RESULTS}}`; also added `processReviewConditionals()` call for `{{#if REVIEW_ROUND_N}}` blocks | TASK-278 |
| Date shows '12/31/1' instead of '12/31/2001' | Fixed: `toLocaleDateString()` without options can produce abbreviated years; use explicit options `{ year: 'numeric', month: 'numeric', day: 'numeric' }` to ensure 4-digit year display; also add null/invalid date guards | TASK-255 |
| Dashboard initiative progress shows 0/0 | Fixed: `DashboardInitiatives` was calculating progress from `initiative.tasks` (unpopulated by API) while Sidebar used `getInitiativeProgress(tasks)` from task store; now both use task store for consistent counts | TASK-276 |
| View mode dropdown disabled on clean URL | Fixed: `swimlaneDisabled` was using store value `currentInitiativeId` which includes localStorage-persisted state; changed to use URL param `searchParams.get('initiative')` as source of truth; clean URL (`/board`) now enables dropdown even with stale localStorage filter | TASK-275 |
| Worktrees orphaned after task completion | Fixed: `CleanupWorktree(taskID)` reconstructed paths assuming default naming, but initiative-prefixed worktrees use different names; `CleanupWorktreeAtPath(path)` now used with stored executor worktree path; `orc cleanup --orphaned` regex updated to match `TASK-XXX` anywhere in directory name | TASK-282 |
| 'completed!' shown when sync fails | Fixed: `completeTask()` returned nil when sync failed with conflicts, so CLI showed celebration message; now returns `ErrTaskBlocked` sentinel error; CLI checks `errors.Is(err, executor.ErrTaskBlocked)` and calls `TaskBlocked()` display instead of `TaskCompleted()` | TASK-287 |
| Stray spec.md files in repo | Fixed: Added `spec.md` and `artifacts/spec.md` to `.gitignore`; specs now captured via JSON `artifact` field using `--json-schema` constrained output and stored in database | TASK-292 |
| Decision IDs collide across initiatives | Fixed: `initiative_decisions` table now uses composite primary key `(id, initiative_id)` instead of `id` alone; decision IDs like DEC-001 are per-initiative, not global; migration 018 (SQLite) and 005 (PostgreSQL) handle existing data | TASK-414 |
| Task marked completed when PR merge fails | Fixed: `completeTask()` now checks for `ErrMergeFailed` and blocks task with `blocked_reason=merge_failed`; `MergePR()` implements retry logic with rebase for HTTP 405 "Base branch was modified" errors; task status becomes `StatusBlocked` instead of false positive `StatusCompleted` | TASK-437 |
| PhaseMax timeout not enforced (phases hang forever) | Fixed: `ExecutePhase()` now called via `executePhaseWithTimeout()` wrapper that applies `context.WithTimeout(ctx, PhaseMax)` if `PhaseMax > 0`; same pattern applied to `FinalizeTask()`; timeout errors produce `phaseTimeoutError` type to distinguish from parent context cancellation | TASK-439 |
| Task left in 'running' after spec extraction fails | Fixed: `ExecuteTask()` now calls `failTask()` before returning errors for all three spec extraction failure paths (empty output, extraction error, database save error); task status correctly becomes `StatusFailed` instead of orphaned in `StatusRunning` | TASK-438 |
| `orc log --follow` says "may not be running" for active tasks | Fixed: JSONLPath now persisted immediately after executor sets it (not just at phase end); fallback path construction added when JSONLPath empty; error messages now show actual task status with actionable guidance | TASK-460 |
| Worktree on wrong branch causes infinite review loop | Fixed: `cleanWorktreeState()` now verifies and corrects branch on worktree reuse; post-creation validation added to `SetupWorktreeForTask()`; logs warning when switching branches; verifies expected branch exists before checkout | TASK-392 |
| `orc log` shows "No transcripts found" when database empty | Fixed: Added filesystem fallback via `readFilesystemTranscripts()` that reads markdown files from `.orc/tasks/{taskID}/transcripts/`; parses filenames in formats `{seq}-{phase}-{iter}.md` and `{phase}-{seq}.md`; enables viewing transcripts even when database sync didn't run | TASK-481 |
| Old tasks run with outdated phases after template update | Fixed: `orc run` now auto-detects stale plans via `IsPlanStale()` (checks version, phase sequence, inline prompts) and auto-migrates before execution; completed/skipped phases preserved; bulk migration via `orc migrate plans --all` | TASK-498 |
| PR creation fails with 'No commits between branches' | Fixed: `WorkflowExecutor.autoCommitBeforeCompletion()` now auto-commits uncommitted changes before PR/merge if Claude didn't commit during implement phase; uses `HasUncommittedChanges()` to detect dirty worktree, stages with `git add -A`, commits with message "[orc] TASK-XXX: Auto-commit before PR creation" | TASK-512 |
| Initiative shows BLOCKED when all tasks complete | Fixed: Initiative completion only triggered for branch-based initiatives; added `CheckAndCompleteInitiativeNoBranch()` called after task completion to auto-complete initiatives without `BranchBase` when all tasks finish; updates initiative status from `active` to `completed` | TASK-525 |
| Stats page stuck in infinite loading skeleton | Fixed: Race condition in statsStore where `setPeriod` and component `useEffect` both triggered fetches; added `_fetchingPeriod` guard to prevent duplicate concurrent fetches for same period; changed initial loading state to `true` (show skeleton immediately); `setPeriod` now only updates period (component `useEffect` triggers fetch) | TASK-526 |
| WebSocket clients don't receive real-time updates | Fixed: EventServer wasn't forwarding events to WebSocketHub; added `SetWebSocketHub()` method and `handleInternalEvent()` to wire event flow; `internalToWSEventType()` converts internal event types to WebSocket EventType constants | TASK-537 |
| UI Run button only updates status, doesn't execute | Fixed: `RunTask` RPC now uses `TaskExecutorFunc` callback pattern; `NewTaskServerWithExecutor()` wires `s.startTask` to spawn actual executor; status reverts on spawn failure; API server must be initialized with executor callback or RunTask only validates | TASK-538 |
| Header session stats (Session, Tokens, Cost) always show 0 | Fixed: API server's `startTask`/`resumeTask` now pass `WithWorkflowSessionBroadcaster(s.sessionBroadcaster)` to WorkflowExecutor; Server struct has `sessionBroadcaster` field initialized in `New()`; without this wiring, session_update events never broadcast | TASK-539 |
| Board doesn't show newly created tasks | Fixed: Board component wasn't subscribed to WebSocket events; added `useWebSocket()` hook call to subscribe to real-time updates; event handlers in `lib/events/handlers.ts` dispatch `taskStore.addTask()` on `taskCreated` events, but components must subscribe to receive them | TASK-555 |
| Radix dropdown options unclickable in modals | Fixed: Dropdown trigger button needs explicit z-index when open to prevent modal backdrop from intercepting clicks; add ref to trigger, use useEffect to set `style.zIndex = '50'` when `dropdownOpen` is true; occurs with Radix DropdownMenu inside Radix Dialog | TASK-556 |
| Initiatives page shows 0/0 tasks for all initiatives | Fixed: `LinkTasks` and `UnlinkTasks` handlers returned stale task object after modification instead of reloading; added `GetTask()` reload after `UpdateTask()` to return fresh state with updated timestamps and normalized data; follows "reload after write" pattern for API response consistency | TASK-552 |
| Stats page shows Avg Task Time as 0:00 and Most Active Initiatives as No data | Fixed: `statsStore.ts` wasn't properly fetching from `GetMetrics()` and `GetTopInitiatives()` APIs; `GetMetrics()` now calculates `avgTaskDurationSeconds` from completed tasks with valid start/completion times; `GetTopInitiatives()` now loads initiative titles from storage (not just IDs); frontend aggregates daily metrics for period-accurate stats | TASK-553 |
| GitHub auto-merge requires GraphQL | `EnableAutoMerge` returns `ErrAutoMergeNotSupported` for GitHub (REST API doesn't support it); GitLab fully supports via `MergeWhenPipelineSucceeds` | hosting-enhancement |
| Sync-on-start failures left zombie worktrees and branches | Fixed: Executor now calls `CleanupWorktreeAtPath()` + branch deletion unconditionally on sync failure (ignores `CleanupOnFail` config since no phases ran); cleanup logged at INFO level; enables retry by removing stale worktree directory and orphaned branch | TASK-499 |

## Decisions

| Decision | Rationale | Source |
|----------|-----------|--------|
| Sync at completion (default) | Balance safety vs overhead; phase-level sync adds latency for marginal benefit | TASK-019 |
| Flipped auto-merge defaults to OFF | Auto-merge/poll defaults changed from true to false; users must explicitly opt in; prevents unexpected automated merges for new users | hosting-enhancement |
| Provider interface over CLI | Hosting operations use Go API clients (go-github v82, go-gitlab) instead of `gh` CLI; enables multi-provider support and better error handling | hosting-enhancement |
